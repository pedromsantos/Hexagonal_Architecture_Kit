# Katacombs Game API - User Stories

**Project**: Katacombs Text-Based Adventure Game API
**Architecture**: Hexagonal Architecture (Ports & Adapters) with Domain-Driven Design
**Development Methodology**: Pedro's Algorithm (London School TDD, Outside-In)

**Total Estimated Effort**: 13-16 days

---

## Story 1: Start Game with Player Creation

**Status**: Ready for Review
**Priority**: High (Foundation)
**Estimate**: 2-3 days

### User Story

As a **player**
I want to **start a new game**
So that I can **begin exploring the katacombs**

### Acceptance Criteria

#### AC1: Successful Game Start

**Given** I provide a valid player name and unique SID
**When** I start a new game via POST /game/player
**Then**:

- A new player is created with the provided name and SID
- The player is placed at the starting location (Truman Brewery)
- I receive a 201 Created response with player details
- The response includes: sid, name, location description, bag (empty), available exits

#### AC2: Player Name Validation

**Given** I attempt to start a game
**When** I provide an invalid player name (empty, too long >50 chars, or invalid characters)
**Then**:

- The game is not started
- I receive a 400 Bad Request response
- The error message indicates the validation failure

#### AC3: Unique Player SID

**Given** I provide a player SID
**When** The SID format is valid (pattern: XXXXXX-XXXXXXXXXXXX-XXXXXXXX)
**Then**:

- The player is created with that SID
- The SID uniquely identifies the player throughout the game

#### AC4: Initial Game State

**Given** A new game has started
**When** I query my player state
**Then**:

- My location is the starting location
- My bag is empty (0 items, 0 gold)
- I can see the starting location description
- I can see available exits from the starting location

### Business Rules

1. **Player Name Requirements**:

   - Must be 1-50 characters
   - Cannot be empty or whitespace only

2. **Player SID Requirements**:

   - Format: `^[0-9]{6}-[0-9]{12}-[00-9]{8}$`
   - Must be unique across all active players
   - Provided by external system (not generated by domain)

3. **Starting Location**:

   - All players begin at the same predefined starting location
   - Starting location is defined in the World aggregate
   - Starting location must have a description and at least one exit

4. **Initial Bag State**:
   - New players start with an empty bag
   - Bag capacity is 10 items
   - Gold counter starts at 0

### Domain Concepts

#### Aggregates

- **Player** (Aggregate Root)

  - Sid (unique identifier)
  - PlayerName (1-50 chars)
  - location_sid (reference to current Location)
  - Bag (collection of items, max 10)
  - is_active (boolean, starts True)

- **World** (Aggregate Root)
  - Contains all locations
  - Defines starting location
  - Immutable during gameplay (read-only)

#### Value Objects

- **Sid**: Unique identifier (pattern: `^[0-9]{6}-[0-9]{12}-[00-9]{8}$`)
- **PlayerName**: String validation (1-50 chars)
- **Bag**: Collection with capacity constraint (max 10 items)

#### Entities (within World aggregate)

- **Location**: Has sid, description, exits, items

#### Domain Events

- **GameStarted**: Raised when new game begins

  - player_sid
  - player_name
  - starting_location_sid
  - timestamp

- **PlayerCreated**: Raised when player aggregate is created

  - player_sid
  - player_name
  - timestamp

- **PlayerPlacedAtLocation**: Raised when player is positioned at starting location
  - player_sid
  - location_sid
  - timestamp

### API Endpoint Mapping

**Endpoint**: `POST /game/player`

**Request Body**:

```json
{
  "name": "Pedro",
  "sid": "001001-999199919878-99989798"
}
```

**Success Response (201 Created)**:

```json
{
  "sid": "001001-999199919878-99989798",
  "name": "Pedro",
  "location": {
    "description": "YOU ARE STANDING AT THE END OF BRICK LANE BEFORE A SMALL BRICK BUILDING CALLED THE OLD TRUMAN BREWERY...",
    "exits": ["north", "east"],
    "items": []
  },
  "bag": {
    "items": [],
    "gold": 0
  }
}
```

**Error Responses**:

- 400 Bad Request: Invalid name or SID format
- 409 Conflict: Player SID already exists

### Technical Implementation Notes

#### CQRS Pattern

- **Command**: StartGameCommand

  - player_name: str
  - player_sid: str (provided by caller)

- **Command Handler**: StartGameCommandHandler
  - Validates player name and SID format
  - Loads World aggregate to get starting location
  - Creates Player aggregate
  - Persists Player via PlayerRepository
  - Raises domain events
  - Returns StartGameResponse

#### Driven Ports (Secondary)

- **PlayerRepository**: Save new player

  - `save(player: Player) -> None`
  - `find_by_sid(sid: Sid) -> Player | None`

- **WorldRepository**: Load world to get starting location
  - `get_world() -> World`

#### Driving Ports (Primary)

- **HTTP Adapter** (FastAPI controller)
  - POST /game/player endpoint
  - Validates request body
  - Invokes StartGameCommandHandler
  - Returns HTTP response

### Out of Scope

- Player authentication/authorization
- Multiple concurrent players (same SID)
- Player preferences/settings
- Custom starting locations
- Tutorial or onboarding flow
- Save/load game state

### Dependencies

- World aggregate must be pre-configured with locations
- Starting location must be defined in World

---

## Story 2: Move Through Locations

**Status**: Ready for Review
**Priority**: High (Core Mechanic)
**Estimate**: 2-3 days

### User Story

As a **player**
I want to **move through the game world in cardinal directions** (north, south, east, west, up, down)
So that I can **explore the Katacombs and discover new locations, items, and treasures**

### Acceptance Criteria

#### AC1: Successful Movement

**Given** I am a player in an active game at a location with available exits
**When** I move in a direction that has a valid exit (e.g., "north")
**Then**:

- My location is updated to the destination location
- I receive a successful response (HTTP 200)
- I can view my new location with its description, exits, and items

#### AC2: Invalid Movement - No Exit

**Given** I am a player at a location without an exit in a specific direction
**When** I attempt to move in that direction (e.g., "north" when no north exit exists)
**Then**:

- My location remains unchanged
- I receive an error response (HTTP 405 - Method Not Allowed)
- An error message indicates the direction is blocked

#### AC3: Invalid Movement - Unknown Player

**Given** I am not an active player in the game
**When** I attempt to move in any direction
**Then**:

- I receive an error response (HTTP 404 - Player Not Found)
- An error message indicates the player does not exist

#### AC4: Movement with Location Update

**Given** I have successfully moved to a new location
**When** I query my current location (GET /player/{playerSid}/location)
**Then**:

- I see the new location's description
- I see the available exits from this location
- I see items present at this location
- The location reflects my actual current position

#### AC5: Multiple Sequential Moves

**Given** I am a player exploring the world
**When** I perform multiple valid moves in sequence (e.g., north, then east, then down)
**Then**:

- Each move updates my location correctly
- Each move validates the exit exists before allowing movement
- My final location reflects the cumulative path I've taken

### Business Rules

1. **Exit Existence**: Players can only move through exits that exist at their current location
2. **Bidirectional Connections**: Location connections must be bidirectional
   - If Location A has a north exit to Location B
   - Then Location B must have a south exit to Location A
   - This applies to all direction pairs: north/south, east/west, up/down
3. **Active Player Requirement**: Only active players can move (players who haven't quit the game)
4. **Valid Directions**: Movement is restricted to the six cardinal directions: north, south, east, west, up, down
5. **Location Existence**: Destination locations referenced in exits must exist in the World
6. **Exit Consistency**: Each location maintains a dictionary of valid exits with destination SIDs
7. **Immutable World**: Location connections cannot be modified during gameplay (read-only World aggregate)

### Domain Concepts

#### Aggregates

- **Player** (Aggregate Root)

  - Sid (player identifier)
  - name (player name)
  - location_sid (current location reference)
  - bag (inventory)
  - is_active (game status)

- **World** (Aggregate Root - read-only)
  - locations (complete map of all locations)
  - starting_location_sid (entry point)

#### Value Objects

- **Sid**: Unique identifier for entities
- **Direction**: Enum representing cardinal directions (NORTH, SOUTH, EAST, WEST, UP, DOWN)

#### Entities (within World aggregate)

- **Location**
  - sid (location identifier)
  - description (location narrative)
  - exits (dictionary mapping Direction to destination Sid)
  - items (list of items present)

#### Domain Events

- **PlayerMovedToLocation**: Raised when player successfully moves
  - player_sid
  - from_location_sid
  - to_location_sid
  - direction
  - timestamp

#### Domain Services

- **MovementValidator**: Validates movement is allowed
  - Checks exit exists at current location
  - Checks destination location exists in World
  - Checks player is active

### API Endpoint Mapping

**Endpoint**: `PUT /player/{playerSid}/move/{direction}`

**Parameters**:

- `playerSid` (path): Player's unique identifier (Sid format)
- `direction` (path): Direction enum (north|south|east|west|up|down)

**Responses**:

- `200 OK`: Successful movement (no response body per OpenAPI spec)
- `404 Not Found`: Player with playerSid not found
- `405 Method Not Allowed`: Cannot move in requested direction (no valid exit)

### Related Endpoints

- `GET /player/{playerSid}/location` - Verify new location after movement

### Technical Implementation Notes

#### CQRS Pattern

- **Command**: MovePlayerCommand

  - player_sid: Sid
  - direction: Direction

- **Command Handler**: MovePlayerCommandHandler
  - Orchestrates movement operation
  - Validates movement through domain service
  - Updates player location via Player aggregate
  - Persists updated Player through PlayerRepository
  - Raises PlayerMovedToLocation domain event

#### Driven Ports (Secondary)

- **PlayerRepository**: Load and save Player aggregate

  - `find_by_sid(sid: Sid) -> Player | None`
  - `save(player: Player) -> None`

- **WorldRepository**: Load World aggregate (read-only)
  - `get_world() -> World`

#### Domain Logic Flow

1. Load Player from repository by SID
2. Validate Player exists and is active
3. Load World aggregate
4. Get Current Location using player.location_sid
5. Validate Exit exists in requested direction
6. Get Destination location SID from exit
7. Move Player: `player.move_to_location(destination_sid)`
8. Persist Player via repository
9. Raise PlayerMovedToLocation event

### Out of Scope

- Looking in a direction before moving (separate query)
- Picking up or dropping items during movement
- Automatic item collection when entering location
- Movement history or backtracking functionality
- Movement restrictions based on inventory (e.g., heavy items)
- Movement costs (stamina, energy)
- Special movement mechanics (teleportation, flying)
- Creating or modifying location connections
- Multi-player collision detection

### Dependencies

- Story 1 (Start Game): Requires Player aggregate and World aggregate

---

## Story 3: Look Around and Inspect

**Status**: Ready for Review
**Priority**: High (Information Discovery)
**Estimate**: 2-3 days

### User Story

As a **player** in the Katacombs game
I want to **view my current location details and inspect items I encounter**
So that **I can understand my surroundings and make informed decisions about where to go and what items to interact with**

### Acceptance Criteria

#### AC1: Look Around Current Location

**Given** I am a registered player in the game
**And** I am standing at a location in the world
**When** I request to look around my current location
**Then** I receive a description of the location including:

- Location description text
- Available exits (directions I can move)
- Items present at the location (with sid and name)

#### AC2: Look in a Specific Direction

**Given** I am a registered player at a location with multiple exits
**When** I look in a specific direction (north, south, east, west, up, down)
**Then**:

- If there is an exit in that direction, I receive the description of the adjacent location
- If there is no exit in that direction, I receive a 405 Method Not Allowed error

#### AC3: Inspect Item Details

**Given** I am aware of an item's SID (from looking around or from my bag)
**When** I request detailed information about the item
**Then** I receive:

- Item SID
- Item name
- Detailed description of the item
- Available actions I can perform on the item (open, close, pick, drop, use)

#### AC4: Inspect Non-existent Item

**Given** I provide an item SID that does not exist in the world
**When** I request detailed information about that item
**Then** I receive a 404 Not Found error with an appropriate message

#### AC5: Player Not Found

**Given** I use an invalid or non-existent player SID
**When** I attempt to look around or look in a direction
**Then** I receive a 404 Not Found error indicating the player was not found

### Business Rules

1. **Location Visibility**: Players can only view the location where they are currently standing
2. **Direction Viewing**: Looking in a direction shows the adjacent location if an exit exists in that direction
3. **Item Visibility**: All items at a location are always visible (no hidden items in this story)
4. **Exit Information**: Shows all available directions from current position
5. **Global Item Inspection**: Items can be inspected by any player regardless of location (global lookup by SID)
6. **Action Display**: Item details include all possible actions, not just currently available ones
7. **Item Properties**: Items maintain their properties regardless of whether they are in a location or in a player's bag

### Domain Concepts

#### Aggregates

- **Player** (existing) - Player requesting location/item information
- **World** (existing) - Aggregate root containing all locations and providing traversal methods

#### Entities

- **Location** (existing) - Contains description, exits, and items
- **Item** (existing) - Contains sid, name, description, and available actions

#### Value Objects

- **Sid** (existing) - Unique identifier for players, locations, and items
- **Direction** (existing) - Enum for movement directions (NORTH, SOUTH, EAST, WEST, UP, DOWN)
- **Action** (existing) - Enum for item actions (OPEN, CLOSE, PICK, DROP, USE)

#### Queries (CQRS Read Side)

- **GetPlayerLocationQuery** - Retrieve current player location with full details
- **LookInDirectionQuery** - Retrieve adjacent location in specified direction
- **GetItemDetailsQuery** - Retrieve detailed item information by SID

#### Query Handlers

- **GetPlayerLocationQueryHandler** - Handles looking around current location
- **LookInDirectionQueryHandler** - Handles looking in specific direction
- **GetItemDetailsQueryHandler** - Handles item inspection

#### DTOs/Response Models

- **LocationResponse** - Contains description, exits array, items array
- **ItemResponse** - Contains sid, name, description, actions array

### API Endpoint Mapping

#### 1. Look Around Current Location

```
GET /player/{playerSid}/location
Response 200: LocationResponse (description, exits, items)
Response 404: Player not found
```

#### 2. Look in Specific Direction

```
GET /player/{playerSid}/look/{direction}
Parameters: direction = north|south|east|west|up|down
Response 200: LocationResponse for adjacent location
Response 404: Player not found
Response 405: No exit in that direction
```

#### 3. Inspect Item Details

```
GET /player/items/{itemSid}
Response 200: ItemResponse (sid, name, description, actions)
Response 404: Item not found
```

### Technical Implementation Notes

#### Query Pattern (CQRS)

- These are read-only operations that don't modify state
- Use query handlers, not command handlers
- No domain events are raised
- No business logic validation beyond existence checks

#### Repository Operations (Read-Only)

- **PlayerRepository.find_by_sid()** - Retrieve player to get current location
- **WorldRepository.get_world()** - Load world aggregate for location and item lookups
- World aggregate handles:
  - `world.get_location(location_sid)` - Get location by SID
  - `world.get_item_by_sid(item_sid)` - Get item from anywhere in world

### Out of Scope

- Moving to a location (separate story - PUT operation)
- Picking up or dropping items (separate story - state modification)
- Using items or performing actions (separate story - complex domain logic)
- Tracking player visit history
- Hidden or locked locations
- Item visibility based on conditions
- Player bag inspection (separate endpoint: GET /player/{playerSid}/bag)
- Distance-based visibility (can only see adjacent locations)
- Description changes based on state

### Dependencies

- Story 1 (Start Game): Requires Player and World aggregates
- Story 2 (Move): Benefits from movement to test different locations

---

## Story 4: Manage Inventory (Bag)

**Status**: Ready for Review
**Priority**: High (Core Mechanic)
**Estimate**: 2-3 days

### User Story

As a **player** exploring the Katacombs
I want to **pick up items from locations, drop items, and view my bag contents**
So that **I can collect treasures, manage my limited inventory space, and strategically decide what to carry**

### Acceptance Criteria

#### AC1: View Bag Contents

**Given** I am an active player in the game
**When** I request to view my bag contents via `GET /player/{playerSid}/bag`
**Then**:

- I receive a list of all items currently in my bag
- Each item shows its SID, name, description, and available actions
- The bag displays my total gold collected
- If my bag is empty, I receive an empty items array

#### AC2: Pick Item from Location

**Given** I am at a location with available items
**And** my bag contains fewer than 10 items
**When** I pick an item via `PUT /player/{playerSid}/item/{itemSid}/use/pick`
**Then**:

- The item is added to my bag
- The item is removed from the location
- I receive a success message
- The item appears in my bag when I view contents

#### AC3: Enforce Bag Capacity Limit

**Given** my bag already contains 10 items
**When** I attempt to pick another item
**Then**:

- The pick action fails
- I receive an error message: "Bag is full (10/10 items)"
- The item remains at the location
- My bag contents remain unchanged

#### AC4: Drop Item at Location

**Given** I have an item in my bag
**When** I drop the item via `PUT /player/{playerSid}/item/{itemSid}/use/drop`
**Then**:

- The item is removed from my bag
- The item appears at my current location
- I receive a success message
- The location shows the dropped item when I look around

#### AC5: Collect Gold Automatically

**Given** I visit a location with gold for the first time
**When** I look around or move to that location
**Then**:

- The gold is automatically added to my bag's gold total
- The gold does not count toward the 10-item bag limit
- The gold amount is visible when I view my bag
- Subsequent visits do not collect the gold again

#### AC6: Pick Non-existent Item

**Given** I am at a location
**When** I attempt to pick an item that doesn't exist at my current location
**Then**:

- The pick action fails with 404 Not Found
- I receive an error message: "Item not found at this location"
- My bag contents remain unchanged

#### AC7: Drop Item Not in Bag

**Given** I am an active player
**When** I attempt to drop an item I don't have in my bag
**Then**:

- The drop action fails with 404 Not Found
- I receive an error message: "Item not in your bag"
- The location items remain unchanged

### Business Rules

1. **Bag Capacity Constraint**: Maximum 10 items can be carried at once
2. **Gold Collection**: Gold is collected automatically on first visit/first open and doesn't count toward item limit
3. **Item Location**: Items can only be picked from the player's current location
4. **Item Availability**: Only items with the "pick" action can be picked up
5. **Drop Anywhere**: Items can be dropped at any location (player's current location)
6. **Gold Persistence**: Gold total persists across the entire game session
7. **Item Uniqueness**: Each item has a unique SID across the entire world

### Domain Concepts

#### Aggregates

- **Player** (Aggregate Root)
  - Contains Bag as part of its state
  - Enforces bag capacity rules
  - Handles item pickup and drop operations

#### Value Objects

- **Bag**: Collection of item SIDs with capacity constraint (max 10)

  - `item_sids: list[Sid]` - List of item references
  - `gold: int` - Total gold collected (separate from item limit)
  - Methods: `add_item()`, `remove_item()`, `has_item()`, `is_full()`, `item_count()`

- **Sid**: Unique identifier for items, players, and locations

#### Entities

- **Item**: Domain entity with SID, name, description, and available actions
- **Location**: Can contain items that players can interact with

#### Domain Events

- **ItemPickedUp**: When player successfully picks an item
- **ItemDropped**: When player successfully drops an item
- **BagCapacityReached**: When player attempts to exceed bag limit
- **GoldCollected**: When player collects gold automatically

#### Commands

- **PickItemCommand**: Pick item from location

  - Input: `player_sid`, `item_sid`
  - Validates: item exists at location, bag not full, item has "pick" action

- **DropItemCommand**: Drop item at location

  - Input: `player_sid`, `item_sid`
  - Validates: item in bag, player at valid location

- **ViewBagQuery**: View bag contents
  - Input: `player_sid`
  - Returns: List of items and gold total

### API Endpoint Mapping

#### 1. GET /player/{playerSid}/bag

- Query: View bag contents
- Returns: `Bag` schema with items array and gold total
- Status: 200 OK, 404 Player not found

#### 2. PUT /player/{playerSid}/item/{itemSid}/use/pick

- Command: Pick item from location
- Returns: Success message
- Status: 200 OK, 404 Item/Player not found, 405 Action not available, 422 Bag full

#### 3. PUT /player/{playerSid}/item/{itemSid}/use/drop

- Command: Drop item at location
- Returns: Success message
- Status: 200 OK, 404 Item/Player not found, 405 Action not available

### Technical Implementation Notes

#### CQRS Pattern

- **Commands**: PickItemCommand, DropItemCommand (modify state)
- **Queries**: ViewBagQuery (read-only bag inspection)

#### Repository Operations

- **PlayerRepository**: Load/save player with bag state
- **WorldRepository**: Load world to validate items and locations

#### Validation Rules

1. Player must exist and be active
2. Item must exist in the world
3. For pick: Item must be at player's current location
4. For pick: Bag must not be full (< 10 items)
5. For pick: Item must have "pick" action available
6. For drop: Item must be in player's bag

### Out of Scope

- Opening items containing gold (separate "open" action story)
- Using items for special purposes (separate "use" action story)
- Trading items between players (multiplayer feature)
- Item weight or volume constraints (only count-based limit)
- Item durability or condition
- Automatic item sorting in bag
- Item categorization or filtering
- Moving items between bag slots

### Dependencies

- Story 1 (Start Game): Requires player creation and world loading
- Story 3 (Look Around): Requires location viewing to see available items

---

## Story 5: Use Items (Open/Close/Use)

**Status**: Ready for Review
**Priority**: Medium (Enhanced Interaction)
**Estimate**: 2-3 days

### User Story

As a **Katacombs player**
I want to **interact with items using open, close, and use actions**
So that **I can unlock paths, reveal treasures, and progress through the game**

### Acceptance Criteria

#### AC1: Open an Item That Supports Opening

**Given** I'm playing Katacombs
**And** I'm in a location with an item that supports the "open" action
**When** I perform the "open" action on that item
**Then** I receive a success message "Action completed successfully"
**And** if the item is a container with gold, the gold is automatically collected to my bag

#### AC2: Close an Item That Supports Closing

**Given** I'm playing Katacombs
**And** I'm in a location with an item that supports the "close" action
**When** I perform the "close" action on that item
**Then** I receive a success message "Action completed successfully"

#### AC3: Use an Item in a Specific Location

**Given** I'm playing Katacombs
**And** I'm in a location with an item that supports the "use" action
**When** I perform the "use" action on that item
**Then** I receive a success message "Action completed successfully"
**And** the item behavior is applied in the context of the current location

#### AC4: Attempt Action Not Supported by Item

**Given** I'm playing Katacombs
**And** I'm in a location with an item
**When** I attempt an action not in the item's available_actions list
**Then** I receive a 405 Method Not Allowed error
**And** the message indicates "Action not available for specified item"

#### AC5: Attempt Action on Non-existent Item

**Given** I'm playing Katacombs
**When** I attempt to use an action on an item that doesn't exist
**Then** I receive a 404 Not Found error
**And** the message indicates "Item with Sid not found"

#### AC6: Attempt Action Without Being a Registered Player

**Given** I'm not a registered player
**When** I attempt to use an item action
**Then** I receive a 404 Not Found error
**And** the message indicates "Player with Sid playerSid not found"

#### AC7: Open Container with Gold

**Given** I'm playing Katacombs
**And** I'm in a location with a closed container that contains gold
**When** I perform the "open" action on the container for the first time
**Then** the container is opened
**And** the gold is automatically collected and added to my bag total
**And** I can verify the gold amount increased when I inspect my bag

### Business Rules

1. **Available Actions**: Each item has a list of available_actions that defines what can be done with it
2. **Action Enum**: Valid actions are: open, close, pick, drop, use
3. **Action Support**: Not all items support all actions (e.g., a rock cannot be opened)
4. **Invalid Actions**: Attempting an unavailable action returns HTTP 405 (Method Not Allowed)
5. **Gold Collection**: Opening a container with gold automatically collects the gold (first time only)
6. **Automatic Collection**: Gold collection is automatic and increases the player's total gold in bag
7. **Location Requirement**: Items must exist at the player's current location to be acted upon
8. **Context-Specific Behavior**: Actions may have location-specific behavior (e.g., using a key only works where there's a locked door)

### Domain Concepts

#### Aggregates

- **Player**: Aggregate root containing location, bag, and gold totals
- **World**: Aggregate root containing all locations and items

#### Value Objects

- **Sid**: Unique identifier for items, players, and locations
- **Action**: Enum representing available item actions (open, close, pick, drop, use)
- **Direction**: Enum for movement (north, south, east, west, up, down)

#### Domain Events

- **ItemOpened**: Triggered when an item is opened
- **ItemClosed**: Triggered when an item is closed
- **ItemUsed**: Triggered when an item is used
- **GoldCollected**: Triggered when opening a container reveals gold

#### Entities

- **Item**: Entity within World aggregate, has name, description, and available_actions
- **Location**: Entity within World aggregate, contains items and exits

#### Repositories (Driven Ports)

- `PlayerRepository`: Find and save player state
- `WorldRepository`: Get world aggregate with all locations and items

### API Endpoint Mapping

**Endpoint**: `PUT /player/{playerSid}/item/{itemSid}/use/{action}`

**Path Parameters**:

- `playerSid` (Sid): Player unique identification
- `itemSid` (Sid): Item unique identification
- `action` (Action enum): one of [open, close, pick, drop, use]

**Success Response (200 OK)**:

```json
{
  "message": "Action completed successfully"
}
```

**Error Responses**:

- `404 Not Found`: Player or Item with Sid not found
- `405 Method Not Allowed`: Action not available for specified item

### Technical Implementation Notes

#### Action Validation

The use case must:

1. Verify player exists
2. Load world aggregate
3. Get player's current location from player aggregate
4. Find item at current location via world aggregate traversal
5. Validate action is in item's available_actions list
6. Execute action with location context

#### Gold Collection Logic

When opening containers:

1. Check if item has associated gold
2. If first time opening, collect gold
3. Update player's bag gold total
4. Emit `GoldCollected` event

### Out of Scope

- Taking items (pick action) - covered in Story 4
- Dropping items (drop action) - covered in Story 4
- Item durability or usage limits
- Multi-step item interactions
- Item combinations
- Trading items between players

### Dependencies

- Story 1 (Start Game): Requires Player and World aggregates
- Story 4 (Manage Inventory): Bag must handle gold collection

---

## Story 6: Quit Game

**Status**: Ready for Review
**Priority**: Medium (Lifecycle Management)
**Estimate**: 1 day

### User Story

As a **player**
I want to **quit my current game session**
So that **I can end my gameplay and see a summary of my accomplishments**

### Acceptance Criteria

#### AC1: Successfully Quit an Active Game

**Given** I am an active player with player SID "001001-999199919878-99989798"
**And** I have collected items in my bag during gameplay
**When** I send a DELETE request to `/game/001001-999199919878-99989798`
**Then** the response status is 200 OK
**And** the response contains a message "Game Over"
**And** my player is marked as inactive in the system
**And** my player record is removed from the active players list

#### AC2: Attempt to Quit with Non-existent Player

**Given** no player exists with SID "999999-999999999999-99999999"
**When** I send a DELETE request to `/game/999999-999999999999-99999999`
**Then** the response status is 404 Not Found
**And** the response indicates the player was not found

#### AC3: Quit Game Preserves Final State Before Removal

**Given** I am an active player with items in my bag
**And** I am at a specific location
**When** I quit the game
**Then** my final game state (location, bag contents) is preserved before deletion
**And** the player is marked as inactive
**And** the player is removed from active players list

### Business Rules

1. **Active Players Only**: Only active players can quit the game
2. **Valid SID Format**: Player SID must be valid (format: `XXXXXX-XXXXXXXXXXXX-XXXXXXXX`)
3. **State Transition**: Quitting the game marks the player as inactive before removal
4. **State Capture**: Player's final state (items collected, location) is captured before deletion
5. **Idempotency**: Quitting is idempotent - multiple quit requests for the same player return appropriate responses
6. **No Further Actions**: After quitting, the player cannot perform any further game actions

### Domain Concepts

#### Aggregates

- **Player** (root): The player who is quitting the game
  - Properties: sid, name, location_sid, bag, is_active
  - Behavior: quit_game() - marks player as inactive

#### Value Objects

- **Sid**: Player's unique identifier
- **Bag**: Collection of item SIDs representing items collected during the game

#### Domain Events

- **GameEnded**: Raised when a player successfully quits the game
  - Data: player_sid, final_location_sid, items_collected_count, timestamp
- **PlayerRemoved**: Raised when player is removed from active players
  - Data: player_sid, timestamp

#### Repositories (Driven Ports)

- **PlayerRepository**:
  - `find_by_sid(player_sid: Sid) -> Player | None`
  - `delete(player_sid: Sid) -> bool`
  - `save(player: Player) -> None`

#### Use Case (Primary Port)

- **QuitGameCommandHandler**: Orchestrates the quit game workflow
  - Input: QuitGameCommand (player_sid)
  - Output: QuitGameResponse (message: "Game Over")
  - Throws: PlayerNotFoundError if player doesn't exist

### API Endpoint Mapping

**Endpoint**: `DELETE /game/{playerSid}`

**Request**:

- Path parameter: `playerSid` (string, pattern: `^[0-9]{6}-[0-9]{12}-[00-9]{8}$`)

**Responses**:

- **200 OK**: Game quit successfully
  ```json
  {
    "message": "Game Over"
  }
  ```
- **404 Not Found**: Player with specified SID not found

### Technical Implementation Notes

#### Command Flow (CQRS Write Side)

1. HTTP adapter receives DELETE request with player_sid
2. Adapter invokes QuitGameCommandHandler with QuitGameCommand
3. Command handler loads Player aggregate from PlayerRepository
4. If player not found, throw PlayerNotFoundError (returns 404)
5. Player aggregate executes quit_game() domain behavior (sets is_active = False)
6. Command handler saves updated player state (for audit/history)
7. Command handler raises GameEnded domain event
8. Command handler deletes player from repository
9. Command handler raises PlayerRemoved domain event
10. Return QuitGameResponse with "Game Over" message

#### Domain Behavior

```python
class Player:
    def quit_game(self) -> None:
        """Mark player as inactive (quit the game)"""
        self.is_active = False
```

#### Error Handling

- Invalid player SID format: 400 Bad Request (validated by API layer)
- Player not found: 404 Not Found
- Repository errors: 500 Internal Server Error

### Out of Scope

- Persisting game history after player quits (future story)
- Calculating and displaying final score (future story: requires score/treasure system)
- Leaderboard integration (future story)
- Re-joining with same player SID (future story)
- Exporting game summary/statistics (future story)
- Save game state for later resume (different feature: save/load game)

### Dependencies

- Story 1 (Start Game): Provides Player aggregate and PlayerRepository
- Player domain model with quit_game() behavior
- PlayerRepository with delete() operation

---

## Summary

### Total Stories: 6

### Total Estimated Effort: 13-16 days

#### Critical Path (Must Complete First)

1. **Story 1**: Start Game (2-3 days) - Foundation
2. **Story 2**: Move Through Locations (2-3 days) - Core exploration
3. **Story 3**: Look Around and Inspect (2-3 days) - Information discovery

#### Secondary Features (Can Parallelize)

4. **Story 4**: Manage Inventory (2-3 days) - Item collection
5. **Story 5**: Use Items (2-3 days) - Item interaction
6. **Story 6**: Quit Game (1 day) - Session management

### Architecture Patterns Applied

- ✅ **Hexagonal Architecture** (Ports & Adapters)
- ✅ **Domain-Driven Design** (Aggregates, Value Objects, Domain Events)
- ✅ **CQRS** (Command/Query Separation)
- ✅ **Outside-In TDD** (Pedro's Algorithm, London School)
- ✅ **Repository Pattern** (Aggregate-Repository 1:1 relationship)

### Next Steps

1. Review all user stories with `reviewers/user_story` agent
2. Create architecture plans with `writers/planning/architect` agent
3. Begin TDD implementation cycle following Pedro's Algorithm
